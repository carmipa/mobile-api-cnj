name: ğŸŒ Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Ambiente para deploy'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      platform:
        description: 'Plataforma'
        required: true
        default: 'android'
        type: choice
        options:
          - android
          - ios
          - web
          - all

permissions:
  contents: read
  deployments: write

jobs:
  # ==================== PrÃ©-Deploy ====================
  pre-deploy:
    name: ğŸ” VerificaÃ§Ãµes PrÃ©-Deploy
    runs-on: ubuntu-latest
    
    outputs:
      should-deploy: ${{ steps.check.outputs.should-deploy }}
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: ğŸ“¦ Instalar dependÃªncias
        run: npm ci
      
      - name: âœ… VerificaÃ§Ãµes de seguranÃ§a
        id: check
        run: |
          echo "ğŸ” Executando verificaÃ§Ãµes..."
          
          # Verificar vulnerabilidades
          echo "  - Verificando vulnerabilidades..."
          npm audit --production || true
          
          # Verificar se hÃ¡ commits sem message
          echo "  - Verificando commits..."
          
          # Validar package.json
          echo "  - Validando package.json..."
          test -f package.json && echo "âœ“ package.json OK"
          
          # Resultado
          echo "should-deploy=true" >> $GITHUB_OUTPUT
          echo "âœ… Todas as verificaÃ§Ãµes passaram"

  # ==================== Deploy Android ====================
  deploy-android:
    name: ğŸ¤– Deploy Android
    runs-on: ubuntu-latest
    needs: pre-deploy
    if: ${{ needs.pre-deploy.outputs.should-deploy == 'true' && (github.event.inputs.platform == 'android' || github.event.inputs.platform == 'all') }}
    
    environment:
      name: ${{ github.event.inputs.environment }}
      url: https://play.google.com
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: ğŸ”§ Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: ğŸ“¦ Instalar dependÃªncias
        run: npm ci
      
      - name: ğŸ” Preparar certificados
        run: |
          echo "ğŸ” Verificando certificados..."
          if [ -f "@carmipa__cp2-api-cnj.jks" ]; then
            echo "âœ“ Certificado Android encontrado"
          else
            echo "âš ï¸ Certificado nÃ£o encontrado (usar arquivo local ou secrets)"
          fi
      
      - name: ğŸ—ï¸ Build Android
        run: |
          echo "ğŸ¤– Iniciando build para Android (${{ github.event.inputs.environment }})..."
          echo ""
          echo "ConfiguraÃ§Ãµes:"
          echo "  - Ambiente: ${{ github.event.inputs.environment }}"
          echo "  - Plataforma: Android"
          echo "  - Data: $(date)"
          echo ""
          echo "ğŸ“ Para deploy real, execute:"
          echo "  $ eas build --platform android --profile ${{ github.event.inputs.environment }}"
      
      - name: ğŸ“¤ Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: android-release
          path: |
            app.json
            eas.json
          retention-days: 30

  # ==================== Deploy iOS ====================
  deploy-ios:
    name: ğŸ Deploy iOS
    runs-on: macos-latest
    needs: pre-deploy
    if: ${{ needs.pre-deploy.outputs.should-deploy == 'true' && (github.event.inputs.platform == 'ios' || github.event.inputs.platform == 'all') }}
    
    environment:
      name: ${{ github.event.inputs.environment }}
      url: https://appstoreconnect.apple.com
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: ğŸ“¦ Instalar dependÃªncias
        run: npm ci
      
      - name: ğŸ” Preparar certificados Apple
        run: |
          echo "ğŸ” Verificando certificados Apple..."
          echo "âš ï¸ Configurar secrets do GitHub para produÃ§Ã£o:"
          echo "  - APPLE_TEAM_ID"
          echo "  - APPLE_DEVELOPER_ID"
          echo "  - APPLE_PROVISIONING_PROFILE"
      
      - name: ğŸ—ï¸ Build iOS
        run: |
          echo "ğŸ Iniciando build para iOS (${{ github.event.inputs.environment }})..."
          echo ""
          echo "ConfiguraÃ§Ãµes:"
          echo "  - Ambiente: ${{ github.event.inputs.environment }}"
          echo "  - Plataforma: iOS"
          echo "  - Data: $(date)"
          echo ""
          echo "ğŸ“ Para deploy real, execute:"
          echo "  $ eas build --platform ios --profile ${{ github.event.inputs.environment }}"
      
      - name: ğŸ“¤ Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: ios-release
          path: |
            app.json
            eas.json
          retention-days: 30

  # ==================== Deploy Web ====================
  deploy-web:
    name: ğŸŒ Deploy Web
    runs-on: ubuntu-latest
    needs: pre-deploy
    if: ${{ needs.pre-deploy.outputs.should-deploy == 'true' && (github.event.inputs.platform == 'web' || github.event.inputs.platform == 'all') }}
    
    environment:
      name: ${{ github.event.inputs.environment }}
      url: https://mobile-api-cnj.vercel.app
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: ğŸ“¦ Instalar dependÃªncias
        run: npm ci
      
      - name: ğŸ—ï¸ Build Web
        run: |
          echo "ğŸŒ Iniciando build para Web (${{ github.event.inputs.environment }})..."
          echo ""
          echo "ConfiguraÃ§Ãµes:"
          echo "  - Ambiente: ${{ github.event.inputs.environment }}"
          echo "  - Plataforma: Web"
          echo "  - Data: $(date)"
          echo ""
          echo "ğŸ“ Para deploy real em Vercel/Netlify, execute:"
          echo "  $ npm run web"

  # ==================== PÃ³s-Deploy ====================
  post-deploy:
    name: âœ… PÃ³s-Deploy
    runs-on: ubuntu-latest
    needs: [pre-deploy, deploy-android, deploy-ios, deploy-web]
    if: always()
    
    steps:
      - name: ğŸ‰ Deploy ConcluÃ­do
        if: success()
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘      âœ… DEPLOY EXECUTADO COM ÃŠXITO    â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸš€ Seu aplicativo foi atualizado com sucesso!"
          echo ""
          echo "ğŸ“Š Detalhes:"
          echo "  - Ambiente: ${{ github.event.inputs.environment }}"
          echo "  - Plataforma: ${{ github.event.inputs.platform }}"
          echo "  - Data/Hora: $(date)"
          echo "  - Commit: ${{ github.sha }}"
      
      - name: âš ï¸ Deploy com Falhas
        if: failure()
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘    âŒ FALHA NO DEPLOY - AÃ‡ÃƒO NECESSÃRIAâ•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "âš ï¸ Verifique os logs acima para detalhes"
          echo ""
          echo "ğŸ“‹ Checklist de ResoluÃ§Ã£o:"
          echo "  [ ] Verificar certificados/chaves"
          echo "  [ ] Validar cÃ³digo"
          echo "  [ ] Verificar dependÃªncias"
          echo "  [ ] Revisar logs"
          exit 1
