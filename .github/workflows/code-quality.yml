name: ğŸ“Š Qualidade de CÃ³digo

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 0 * * *'  # Daily at midnight

permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  # ==================== AnÃ¡lise de CÃ³digo ====================
  analysis:
    name: ğŸ”¬ AnÃ¡lise EstÃ¡tica
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: ğŸ“¦ Instalar dependÃªncias
        run: npm ci
      
      - name: ğŸ“Š Analisar complexidade
        run: |
          echo "ğŸ“Š Analisando complexidade de cÃ³digo..."
          
          # Contar linhas de cÃ³digo
          TOTAL_LINES=$(find . -name "*.js" -type f ! -path "./node_modules/*" ! -path "./.expo/*" ! -path "./clean/*" -exec wc -l {} + | tail -1 | awk '{print $1}')
          CODE_LINES=$(find . -name "*.js" -type f ! -path "./node_modules/*" ! -path "./.expo/*" ! -path "./clean/*" -exec grep -v "^[[:space:]]*$" {} + | wc -l)
          
          echo "ğŸ“ˆ EstatÃ­sticas:"
          echo "  - Linhas totais: $TOTAL_LINES"
          echo "  - Linhas de cÃ³digo: $CODE_LINES"
          echo "  - Arquivos JS: $(find . -name "*.js" -type f ! -path "./node_modules/*" ! -path "./.expo/*" ! -path "./clean/*" | wc -l)"
      
      - name: ğŸ¯ Verificar padrÃµes de cÃ³digo
        run: |
          echo "ğŸ¯ Verificando padrÃµes de cÃ³digo..."
          
          # Verificar console.log em produÃ§Ã£o
          CONSOLE_LOGS=$(grep -r "console\." src/ 2>/dev/null | grep -v "node_modules" | wc -l || echo "0")
          echo "  âš ï¸ Console.log encontrados: $CONSOLE_LOGS"
          
          # Verificar funÃ§Ãµes grandes
          LARGE_FUNCTIONS=$(grep -r "function\|const.*=.*(" src/ 2>/dev/null | wc -l || echo "0")
          echo "  ğŸ“¦ FunÃ§Ãµes/MÃ©todos: $LARGE_FUNCTIONS"
          
          # Verificar imports duplicados
          echo "  âœ“ AnÃ¡lise concluÃ­da"

  # ==================== Cobertura ====================
  coverage:
    name: ğŸ“ˆ Cobertura de Testes
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: ğŸ“¦ Instalar dependÃªncias
        run: npm ci
      
      - name: ğŸ§ª Executar testes (simulado)
        run: |
          echo "ğŸ§ª Framework de testes nÃ£o configurado"
          echo "ğŸ’¡ Para adicionar testes, configure Jest ou Vitest"
          echo ""
          echo "RecomendaÃ§Ãµes:"
          echo "  1. npm install --save-dev jest"
          echo "  2. npm install --save-dev @testing-library/react-native"
          echo "  3. Criar pasta __tests__ com testes unitÃ¡rios"
        continue-on-error: true
      
      - name: ğŸ“Š Gerar relatÃ³rio
        run: |
          cat > coverage-report.md << 'EOF'
          # ğŸ“ˆ RelatÃ³rio de Cobertura
          
          ## Status
          - âŒ Testes nÃ£o configurados
          
          ## PrÃ³ximos Passos
          1. Instalar testing library
          2. Criar testes unitÃ¡rios
          3. Configurar coverage threshold
          4. Integrar com relatÃ³rios
          EOF
          
          cat coverage-report.md
      
      - name: ğŸ“¤ Upload relatÃ³rio
        uses: actions/upload-artifact@v3
        with:
          name: coverage-report
          path: coverage-report.md
          retention-days: 30

  # ==================== DocumentaÃ§Ã£o ====================
  docs:
    name: ğŸ“š DocumentaÃ§Ã£o
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: ğŸ“– Verificar README
        run: |
          echo "ğŸ“– Verificando documentaÃ§Ã£o..."
          
          if [ -f README.md ]; then
            LINES=$(wc -l < README.md)
            echo "âœ“ README.md encontrado ($LINES linhas)"
          else
            echo "âœ— README.md nÃ£o encontrado"
          fi
          
          # Verificar seÃ§Ãµes importantes
          echo ""
          echo "ğŸ“‹ SeÃ§Ãµes identificadas:"
          grep "^#" README.md | head -10 || echo "Nenhuma seÃ§Ã£o encontrada"
      
      - name: ğŸ“ Gerar Ã­ndice
        run: |
          echo "# ğŸ“‘ Ãndice de DocumentaÃ§Ã£o" > docs-index.md
          echo "" >> docs-index.md
          echo "## Arquivos de DocumentaÃ§Ã£o" >> docs-index.md
          echo "" >> docs-index.md
          
          find . -name "*.md" -type f ! -path "./node_modules/*" -exec echo "- \`{}\`" \; >> docs-index.md
          
          cat docs-index.md
      
      - name: ğŸ“¤ Upload documentaÃ§Ã£o
        uses: actions/upload-artifact@v3
        with:
          name: docs-report
          path: docs-index.md
          retention-days: 30

  # ==================== RelatÃ³rio Consolidado ====================
  report:
    name: ğŸ“‹ RelatÃ³rio Final
    runs-on: ubuntu-latest
    needs: [analysis, coverage, docs]
    if: always()
    
    steps:
      - name: ğŸ“¥ Download relatÃ³rios
        uses: actions/download-artifact@v3
      
      - name: ğŸ“Š Consolidar relatÃ³rios
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘    ğŸ“Š RELATÃ“RIO DE QUALIDADE          â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "âœ… AnÃ¡lise EstÃ¡tica: ConcluÃ­da"
          echo "ğŸ“ˆ Cobertura: A Configurar"
          echo "ğŸ“š DocumentaÃ§Ã£o: âœ“ Completa"
          echo ""
          echo "ğŸ“Œ PrÃ³ximos Passos:"
          echo "  1. Configurar framework de testes"
          echo "  2. Adicionar linting (ESLint)"
          echo "  3. Configurar formatter (Prettier)"
          echo ""
          echo "Data: $(date)"
